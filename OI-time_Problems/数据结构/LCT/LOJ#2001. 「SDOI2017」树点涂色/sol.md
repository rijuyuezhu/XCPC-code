发现每种颜色的覆盖区域一定是由根出发的一段路径。用 lct 维护树上染色连通块，即同种颜色放在同一颗 Splay 中。那么操作1就是 access 操作。

对于每棵Splay的点，定义 $f(u)$ 表示 $u$ 到根的颜色数量；换句话说， $u$ 到根的路径上 Splay 的数量。于是，容易发现，对于操作2，答案就为 $f(u)+f(v)-2f(\mathrm{lca}(u,v))+1$，对于操作3，就是要求 $\max_{u\in subtree(x)}f(u)$。使用dfs序+数据结构维护 $f(u)$，于是到目前为止，我们需要操作：1)单点查询；2)区间最大值查询。

考虑操作1的 access 对 $f$ 的影响：

众所周知，一般的 access 有以下几个过程：

- 将当前节点旋转到当前 Splay 的根；
- 断掉当前节点连向右儿子的边（实 $\to$ 虚）；
- 使之前的Splay根节点成为当前节点的右儿子（虚 $\to$ 实）；
- 更新信息；
- 跳到父亲。

发现只有第 2,3 步会影响 $f$。考虑贡献，其实就是子树加与子树减，只需要区间加即可。所以，维护 $f$ 的数据结构可以直接线段树。