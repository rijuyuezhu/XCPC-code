二分+树哈希。

对括号序列进行差分，一个节点的 $k$ - 子树的括号序列是它的括号序列抠去它所有 $k$ 级儿子的括号序列。求出每个节点的 $k$ 级儿子，再求区间并合并即可。