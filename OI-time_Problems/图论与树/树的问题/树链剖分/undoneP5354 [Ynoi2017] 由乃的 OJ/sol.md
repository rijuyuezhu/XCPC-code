# P5354 [Ynoi2017] 由乃的 OJ 解题报告

[link](https://www.luogu.com.cn/problem/P5354)

## 题目大意

一棵树，每个点有一个位运算和权值。每次询问给出一条有向链 $(x,y)$，选定一个 $v$，查询从 $x$ 到 $y$ 进行计算可以得到的最大值。同时支持单点修改。

## 解题报告

贪心地从高位到低位，试探每位是否能为1。这里可以树链剖分+线段树（注意链有方向），维护当填入 $0/1$ 时的最优值。需要开 $\log V$ 棵线段树，每次修改/查询为 $O(n\log^2 n\log V)$。无法通过本题。

考虑把若干棵线段树压成一棵。

信息如何快速合并？记录每个点以 全0 及全1 的方法进入得到的结果。设 $f_0(x)$ 是以 全0 进入 $x$ 节点得到的答案， $f_1(x)$ 类似。

则如何从 $x,y$ 两个节点合并得到 $z$ 节点的答案？

比如 $f_0(z)$ 的求法：

若某一位 0 进入 $f_0(x)$ 得到了 0，则这里的 $f_0(z)$ 等同于 $f_0(y)$。

若某一位 0 进入 $f_0(x)$ 得到了 1，则这里的 $f_0(z)$ 等同于 $f_1(y)$。

那么位运算搞一搞，得到

```
f_0(z) = (f_0(y) & ~f_0(x)) | (f_1(y) & f_0(x))
f_1(z) = (f_0(y) & ~f_1(x)) | (f_1(y) & f_1(x))
```

这样就可以 $O(1)$ 合并了。