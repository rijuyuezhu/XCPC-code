# k 短路 学习笔记


## PART 1

求 $s$ 到 $t$ 的 $k$ 短路。

首先，建立出反图中以 $t$ 为根的最短路树。则从 $s$ 到 $t$ 的路径可以分解成树边序列 $E^t$ 和非树边序列 $E$。（许多博客在此的措辞为“集合”，个人觉得不太准确）

为了方便描述，下面设 $E_i=(u_i,v_i,w_i)$。

有这样一个重要性质：若 $E$ 确定了，$E^t$ 即唯一确定了，整条路径就唯一确定了。这是因为最短路树是一棵树。

若设一条非树边为 $e=(u,v,w)$，$\Delta_e=d_v+w-d_u$（其中 $d_u$ 为最短路树上 $u$ 到 $t$ 的距离），则一个非树边序列对应的路径的长度为 $d_s+\sum_{e\in E}\Delta_e$。

综上，问题转化为了求 $\Delta_e$ 和第 $k$ 小的 $E$。

## PART 2

什么样的 $E$ 是合法的呢？需要满足 $1\le i < |E|$，$u_{i+1}$ 是 $v_i$ 的祖先（包括其本身）。

于是我们得出了一个基本的想法：维护可能成为**当前最小值**的 $E$。先选择最小的 $E$，并考虑在它上继续延伸：假设最后一条边为 $e=(u,v,w)$，有两种方法进行延伸：

- 将 $e$ 替换成一个合法的、$w$ 更大的 $e'$，“合法”的选择标准和 $e$ 当时的选择标准一致）
- 在 $e$ 的后面新添一个 $e'$，为了合法，需要 $e'$ 的出发点是 $v_e$ 的祖先（包括其本身）。

到这里就可以想办法维护了，发现可以用堆维护，但时间、空间都会爆表（大概是 $O(mk\log (mk))$ 级别的东西）。观察我们需要得知 从某个点或其祖先出发的非树边，考虑使用“可持久化可并堆”，维护某个点到根的信息。

## PART 3

重新看看两个条件：

假设当前的 $E$ 的最后一条边**所在的可并堆的节点为** $u$。

- 替换操作，选择标准一致，所以延伸出的节点仍然在这个可并堆中。将 $u$ 的左、右儿子加入选择即可。
- 新添操作，直接将 $u$ 对应边的终点对应的可并堆的根加入选择。

每次操作只会添加进 $O(1)$ 个决策点，时间复杂度为 $O((m+k)\log)$